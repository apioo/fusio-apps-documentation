/*
 evid
 Copyright (C) 2015 Christoph Kappestein
 License: MIT
*/
"use strict";angular.module("evid.definition",[]).service("definition",["$http","$q","url","registry",function($http,$q,url,registry){function def(api){this.api=api,this.getRoutings=function(){var routings=[];if(angular.isArray(this.api.routings))if(angular.isArray(evid.exclude))for(var i=0;i<this.api.routings.length;i++){for(var exclude=!1,j=0;j<evid.exclude.length;j++)if(this.api.routings[i].path.match(evid.exclude[j])){exclude=!0;break}exclude||routings.push(this.api.routings[i])}else routings=this.api.routings;return routings},this.getLinkByRel=function(rel){if(this.api&&this.api.links&&angular.isArray(this.api.links))for(var i=0;i<this.api.links.length;i++)if(this.api.links[i].rel==rel)return this.api.links[i].href;return null}}this.initialize=function(){return $q(registry.has("definition")?function(resolve){resolve(registry.get("definition"))}:function(resolve,reject){$http.get(url).then(function(response){registry.set("definition",new def(response.data)),resolve(registry.get("definition"))},function(){reject()})})}}]),angular.module("evid.registry",[]).service("registry",function(){this.container={},this.set=function(name,service){this.container[name]=service},this.get=function(name){return this.has(name)?this.container[name]:null},this.has=function(name){return this.container.hasOwnProperty(name)}}),angular.module("evid.schema",[]).service("schema",function(){function schemaGenerator(definition){this.definition=definition,this.schema=definition.schema,this.getHtml=function(methodName,method){var html="<div>",request=this.getRequest(method);request&&(html+='<md-subheader class="md-primary">'+methodName+" Request</md-subheader>",html+='<div class="evid-schema-table">'+request+"</div>");for(var statusCodes=this.getAvailableResponseCodes(method),i=0;i<statusCodes.length;i++){var response=this.getResponse(method,statusCodes[i]);response&&(html+='<md-subheader class="md-primary">'+methodName+" Response - "+statusCodes[i]+"</md-subheader>",html+='<div class="evid-schema-table">'+response+"</div>")}return html+="</div>"},this.getRequest=function(method){if(method&&method.request){var data=this.getPointer(method.request);if(data)return this.transformSchema(data)}return null},this.getResponse=function(method,statusCode){if(method&&method.responses&&method.responses[statusCode]){var data=this.getPointer(method.responses[statusCode]);if(data)return this.transformSchema(data)}return null},this.getAvailableResponseCodes=function(method){var codes=[];if(method&&method.responses)for(var statusCode in method.responses)codes.push(statusCode);return codes},this.getPointer=function(path){if(!path)return null;"#/"==path.substring(0,2)&&(path=path.substring(2));for(var parts=path.split("/"),el=this.schema,i=0;i<parts.length&&el[parts[i]];i++)el=el[parts[i]];return el},this.resolveRef=function(schema){return schema.$ref&&(schema=this.resolveRef(this.getPointer(schema.$ref))),schema},this.transformSchema=function(schema){return this.buildObject(this.resolveRef(schema))},this.buildObject=function(schema){var html="";if(schema.properties){var references=[],title="Object";schema.title&&(title=schema.title),html+='<md-subheader class="md-hue-1"><strong>'+title+"</strong></md-subheader>",html+="<table>",html+="<colgroup>",html+='    <col width="20%">',html+='    <col width="20%">',html+='    <col width="40%">',html+='    <col width="20%">',html+="</colgroup>",html+="<thead>",html+="<tr>",html+="    <th>Property</th>",html+="    <th>Type</th>",html+="    <th>Description</th>",html+="    <th>Constraints</th>",html+="</tr>",html+="</thead>",html+="<tbody>";for(var propertyName in schema.properties){var property=schema.properties[propertyName];property.$ref&&(property=this.resolveRef(property));var type=property.type?property.type:"string";if("object"==type){var object=this.resolveRef(property);object.title&&(type=object.title),references.push(object)}else if("array"==type&&property.items){var object=this.resolveRef(property.items);"object"==object.type?(type=object.title?"array&lt;"+object.title+"&gt;":"array&lt;object&gt;",references.push(object)):object.type&&(type="array&lt;"+object.type+"&gt;")}html+="<tr>",html+="<td><b>"+propertyName+"</b></td>",html+="<td>"+type+"</td>",html+="<td>"+(property.description?property.description:"")+"</td>",html+="<td>"+this.buildConstraints(property)+"</td>",html+="</tr>"}html+="</tbody>",html+="</table>";for(var i=0;i<references.length;i++)html+=this.buildObject(references[i])}return html},this.buildConstraints=function(property){var html="<dl>";return property.pattern&&(html+="<dt>Pattern:</dt><dd>"+property.pattern+"</dd>"),property["enum"]&&angular.isArray(property["enum"])&&(html+="<dt>Enumeration:</dt><dd>"+property["enum"].join(", ")+"</dd>"),property.minLength&&(html+="<dt>Min-Length:</dt><dd>"+property.minLength+"</dd>"),property.maxLength&&(html+="<dt>Max-Length:</dt><dd>"+property.maxLength+"</dd>"),property.minimum&&(html+="<dt>Minimum:</dt><dd>"+property.minimum+"</dd>"),property.maximum&&(html+="<dt>Maximum:</dt><dd>"+property.maximum+"</dd>"),html+="</dl>"}}this.create=function(definition){return new schemaGenerator(definition)}}),angular.module("evid.api",[]).controller("ApiCtrl",["$scope","$http","$compile","$sce","$mdSidenav","$routeParams","definition","schema",function($scope,$http,$compile,$sce,$mdSidenav,$routeParams,definition,schema){$scope.api,$scope.methods,$scope.loadApi=function(){definition.initialize().then(function(def){var url=def.getLinkByRel("detail");url&&(url=url.replace("{version}","*"),url=url.replace("{path}",$routeParams.api?$routeParams.api:""),$http.get(url).then(function(resp){if($scope.api=resp.data,$scope.api.methods){var methods={};for(var methodName in $scope.api.methods)methods[methodName]=$scope.getSchema(methodName,$scope.api.methods[methodName]);$scope.methods=methods,$mdSidenav("left").close()}}))})},$scope.getSchema=function(methodName,method){var apiSchema=schema.create($scope.api),html=apiSchema.getHtml(methodName,method),linkFn=$compile(html),el=linkFn($scope);return $sce.trustAsHtml(el.html())},$scope.loadApi()}]),angular.module("evid.page",[]).controller("PageCtrl",["$scope","$http","$compile","$sce","$routeParams","$filter","menu",function($scope,$http,$compile,$sce,$routeParams,$filter,menu){$scope.title,$scope.body,$scope.loadDocument=function(){var slugify=$filter("slugify"),item=!1,title=!1;$routeParams.page&&(title=$routeParams.page);for(var i=0;i<menu.length;i++)if(slugify(menu[i].title)==title||title===!1){item=menu[i];break}item?($scope.title=item.title,$http.get(item.href).then(function(resp){var linkFn=$compile(resp.data),el=linkFn($scope);$scope.body=$sce.trustAsHtml(el.html())},function(resp){$scope.title=resp.statusText,$scope.body=""})):($scope.title="Page not found",$scope.body="")},$scope.loadDocument()}]);var evid=angular.module("evid",["ngRoute","ngSanitize","ngMaterial","ngAnimate","hljs","evid.definition","evid.registry","evid.schema","evid.api","evid.page"]);evid.config(["$routeProvider",function($routeProvider){$routeProvider.when("/api/:api*?",{templateUrl:"partials/api.html",controller:"ApiCtrl"}).when("/page/:page?",{templateUrl:"partials/page.html",controller:"PageCtrl"}).otherwise({redirectTo:"/page"})}]),evid.config(function($mdThemingProvider){$mdThemingProvider.theme("default").primaryPalette("blue").accentPalette("grey")}),evid.filter("slugify",function(){return function(input){return input?input.toLowerCase().replace(/\W+/g,"-"):""}}),evid.controller("AppCtrl",["$scope","$http","$mdSidenav","url","menu","definition",function($scope,$http,$mdSidenav,url,menu,definition){$scope.menus=menu,$scope.routings=[],$scope.toggleSidebar=function(){$mdSidenav("left").toggle()},$scope.loadRoutings=function(){definition.initialize().then(function(def){$scope.routings=def.getRoutings()})},$scope.loadRoutings()}]),evid.run(function(){});